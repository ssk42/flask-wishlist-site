{# Partial template for a single item card - used by htmx swaps #}
<div class="col-md-6 col-lg-4 mb-4">
    <div class="glass-card p-3 h-100 d-flex flex-column" id="item-card-{{ item.id }}">
        <!-- Image Section -->
        <div class="position-relative mb-3 rounded overflow-hidden" style="height: 200px;">
            <img src="{{ item.image_url or default_image_url }}" class="w-100 h-100 object-fit-cover"
                alt="Image for {{ item.description }}" loading="lazy">

            <!-- Badges Overlay -->
            <div class="position-absolute top-0 start-0 w-100 p-2 d-flex justify-content-between">
                {% if item.user_id == current_user.id %}
                <span class="badge bg-primary bg-opacity-75 backdrop-blur shadow-sm">Your Item</span>
                {% else %}
                <span class="badge bg-light text-dark bg-opacity-75 backdrop-blur shadow-sm">{{ item.user.name }}</span>
                {% endif %}

                <span class="badge 
                    {{ 'bg-danger' if item.priority == 'High' else 'bg-warning' if item.priority == 'Medium' else 'bg-info' }} 
                    bg-opacity-75 backdrop-blur shadow-sm text-white">
                    {{ item.priority or 'No priority' }}
                </span>
            </div>
        </div>

        <!-- Content -->
        <div class="mb-3">
            <h3 class="h6 fw-bold mb-1 text-truncate" title="{{ item.description }}">{{ item.description }}</h3>

            {% if item.category %}
            <p class="text-xs text-muted mb-1"><i class="bi bi-tag"></i> {{ item.category }}</p>
            {% endif %}

            {% if item.price %}
            <div class="d-flex align-items-center gap-2 mb-1">
                <span class="text-success fw-medium">${{ "%.2f"|format(item.price) }}</span>
                {% if item.price_updated_at %}
                <span class="text-xs text-muted" title="Last updated: {{ item.price_updated_at }}">(as of {{
                    item.price_updated_at.strftime('%b %d') }})</span>
                {% endif %}

                {% if item.link %}
                <form action="{{ url_for('items.refresh_price', item_id=item.id) }}" method="post" class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <button type="submit" class="btn btn-link p-0 text-muted hover-primary" title="Refresh Price">
                        <i class="bi bi-arrow-clockwise" style="font-size: 0.8rem;"></i>
                    </button>
                </form>
                {% endif %}
            </div>
            {% endif %}

            {% if item.size or item.color or (item.quantity and item.quantity > 1) %}
            <div class="d-flex flex-wrap gap-1 mb-1">
                {% if item.size %}
                <span class="badge bg-secondary bg-opacity-75"><i class="bi bi-rulers me-1"></i>{{ item.size }}</span>
                {% endif %}
                {% if item.color %}
                <span class="badge bg-secondary bg-opacity-75"><i class="bi bi-palette me-1"></i>{{ item.color }}</span>
                {% endif %}
                {% if item.quantity and item.quantity > 1 %}
                <span class="badge bg-info bg-opacity-75"><i class="bi bi-stack me-1"></i>&times;{{ item.quantity }}</span>
                {% endif %}
            </div>
            {% endif %}

            {% if item.last_updated_by and item.user_id != current_user.id and item.status == 'Claimed' %}
            <p class="text-xs text-muted fst-italic mb-0">Claimed by {{ item.last_updated_by.name }}</p>
            {% endif %}
        </div>

        <!-- Actions Footer -->
        <div class="mt-auto pt-3 border-top border-light-subtle">
            <div class="d-flex justify-content-between align-items-center mb-2">
                {% if item.user_id == current_user.id %}
                <div class="d-flex gap-2 w-100">
                    <a href="{{ url_for('items.edit_item', item_id=item.id) }}"
                        class="btn btn-sm btn-outline-primary flex-grow-1">Edit</a>
                    <a href="{{ url_for('items.delete_item', item_id=item.id) }}"
                        class="btn btn-sm btn-outline-danger flex-grow-1"
                        onclick="return confirm('Are you sure you want to delete this item?');">Delete</a>
                </div>
                {% else %}
                <!-- Claim/Unclaim Buttons -->
                {% if item.status == 'Available' %}
                <button class="btn btn-sm btn-outline-primary py-0 px-3 rounded-pill"
                    hx-post="{{ url_for('items.claim_item', item_id=item.id) }}" hx-target="#item-card-{{ item.id }}"
                    hx-swap="outerHTML" hx-confirm="Are you sure you want to claim this item?">
                    <i class="bi bi-check2"></i> Claim
                </button>
                {% elif item.status == 'Claimed' and item.last_updated_by_id == current_user.id %}
                <div class="d-flex flex-column gap-2 w-100">
                    <button class="btn btn-sm btn-outline-warning py-0 px-3 rounded-pill w-100"
                        hx-post="{{ url_for('items.unclaim_item', item_id=item.id) }}"
                        hx-target="#item-card-{{ item.id }}" hx-swap="outerHTML"
                        hx-confirm="Are you sure you want to unclaim this item?">
                        <i class="bi bi-x-circle"></i> Unclaim
                    </button>
                    <a href="{{ url_for('items.edit_item', item_id=item.id) }}"
                        class="btn btn-sm btn-primary rounded-pill w-100">
                        <i class="bi bi-pencil-square"></i> Update Status
                    </a>
                </div>
                {% else %}
                <span class="badge bg-light text-muted border py-1 px-2 rounded-pill fw-normal">
                    {{ item.status }}
                </span>
                {% endif %}

                <!-- Link Actions -->
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-link p-0 text-decoration-none text-muted hover-primary"
                        hx-get="{{ url_for('items.get_item_modal', item_id=item.id) }}" hx-target="#quick-view-content"
                        hx-trigger="click" data-bs-toggle="modal" data-bs-target="#quickViewModal" title="Quick View">
                        <i class="bi bi-eye"></i>
                    </button>
                    {% if item.link %}
                    <a href="{{ item.link }}" target="_blank" rel="noopener"
                        class="btn btn-sm btn-link p-0 text-decoration-none text-muted hover-primary"
                        title="Visit Link">
                        <i class="bi bi-box-arrow-up-right"></i>
                    </a>
                    {% endif %}
                </div>
                {% endif %}
            </div>

            <!-- Comments Section (Collapsible) -->
            {% if item.user_id != current_user.id %}
            <div class="border-top pt-2">
                <button
                    class="btn btn-sm btn-link text-decoration-none px-0 w-100 text-start d-flex justify-content-between align-items-center collapsed text-muted"
                    type="button" data-bs-toggle="collapse" data-bs-target="#comments-{{ item.id }}"
                    aria-expanded="false" aria-controls="comments-{{ item.id }}">
                    <span class="small">
                        <i class="bi bi-chat-left-text me-1"></i> Comments ({{ item.comments|length if item.comments
                        else 0 }})
                    </span>
                    <i class="bi bi-chevron-down small"></i>
                </button>
                <div class="collapse mt-2" id="comments-{{ item.id }}">
                    {% if item.comments %}
                    <div class="list-group list-group-flush mb-2 small">
                        {% for comment in item.comments %}
                        <div class="bg-body-secondary bg-opacity-50 p-2 rounded mb-1">
                            <strong>{{ comment.author.name }}:</strong> {{ comment.text }}
                            <div class="text-xs text-muted text-end">{{ comment.created_at.strftime('%b %d, %H:%M') }}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-xs text-muted mb-2 fst-italic ps-2">No comments yet.</p>
                    {% endif %}

                    <form action="{{ url_for('social.add_comment', item_id=item.id) }}" method="post" class="mt-1">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                        <div class="input-group input-group-sm">
                            <input type="text" name="text" class="form-control form-control-sm"
                                placeholder="Secret comment..." required>
                            <button class="btn btn-outline-secondary" type="submit">Post</button>
                        </div>
                        <div class="text-xs text-muted mt-1 fst-italic text-end">Hidden from owner</div>
                    </form>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>