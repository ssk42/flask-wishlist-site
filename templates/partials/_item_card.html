{# Partial template for a single item card - used by htmx swaps #}
<div class="col-md-6 col-lg-4 mb-4">
    <div class="card h-100 shadow-sm">
        <img src="{{ item.image_url or default_image_url }}" class="card-img-top" alt="Image for {{ item.description }}"
            loading="lazy">
        <div class="card-body d-flex flex-column">
            <div class="d-flex align-items-center justify-content-between mb-2">
                {% if item.user_id != current_user.id %}
                <span class="badge rounded-pill bg-secondary status-pill">{{ item.status }}</span>
                {% else %}
                <span class="badge rounded-pill bg-info status-pill">Your Item</span>
                {% endif %}
                <span
                    class="badge rounded-pill {{ 'badge-priority-' ~ item.priority|lower if item.priority else 'bg-light text-dark' }}">{{
                    item.priority or 'No priority' }}</span>
            </div>
            <h3 class="h5">{{ item.description }}</h3>
            {% if item.category %}
            <p class="text-muted mb-1"><strong>Category:</strong> {{ item.category }}</p>
            {% endif %}
            {% if item.price %}
            <p class="mb-1">
                <strong>Price:</strong> ${{ '%.2f'|format(item.price) }}
                {% if item.price_updated_at %}
                <small class="text-muted">(as of {{ item.price_updated_at.strftime('%b %d') }})</small>
                {% endif %}
            </p>
            {% endif %}
            {% if item.link %}
            <div class="d-flex gap-2 mb-2 flex-wrap">
                <a href="{{ item.link }}" target="_blank" rel="noopener" class="btn btn-sm btn-outline-primary">View
                    item</a>
                <form action="{{ url_for('refresh_price', item_id=item.id) }}" method="post" class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <button type="submit" class="btn btn-sm btn-outline-secondary" title="Fetch current price from URL">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor"
                            class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                            <path fill-rule="evenodd"
                                d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z" />
                            <path
                                d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z" />
                        </svg>
                        Refresh Price
                    </button>
                </form>
            </div>
            {% endif %}
            {% if item.last_updated_by and item.user_id != current_user.id %}
            <p class="text-muted small mb-2">Last updated by {{ item.last_updated_by.name }}</p>
            {% endif %}
            <div class="mt-auto pt-3">
                {% if item.user_id == current_user.id %}
                <div class="d-flex justify-content-between">
                    <a href="{{ url_for('edit_item', item_id=item.id) }}" class="btn btn-primary btn-sm">Edit</a>
                    <a href="{{ url_for('delete_item', item_id=item.id) }}" class="btn btn-danger btn-sm"
                        onclick="return confirm('Are you sure you want to delete this item?');">Delete</a>
                </div>
                {% else %}
                <div class="d-flex flex-column">
                    {% if item.status == 'Available' %}
                    <form action="{{ url_for('claim_item', item_id=item.id) }}" method="post" class="mb-2"
                        hx-post="{{ url_for('claim_item', item_id=item.id) }}" hx-swap="outerHTML"
                        hx-target="closest .card" hx-indicator=".htmx-indicator">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                        <button type="submit" class="btn btn-success btn-sm w-100">
                            <span class="htmx-indicator spinner-border spinner-border-sm me-1" role="status"></span>
                            Claim
                        </button>
                    </form>
                    {% elif item.status == 'Claimed' %}
                    <div class="alert alert-success py-1 px-2 mb-2 text-center small">
                        <strong>âœ“ Claimed</strong>
                    </div>
                    {% endif %}
                    <a href="{{ url_for('edit_item', item_id=item.id) }}"
                        class="btn btn-outline-primary btn-sm w-100">Update status</a>
                </div>
                {% endif %}
            </div>

            {% if item.user_id != current_user.id %}
            <div class="border-top mt-3 pt-2">
                <button
                    class="btn btn-sm btn-link text-decoration-none px-0 w-100 text-start d-flex justify-content-between align-items-center collapsed"
                    type="button" data-bs-toggle="collapse" data-bs-target="#comments-{{ item.id }}"
                    aria-expanded="false" aria-controls="comments-{{ item.id }}">
                    <span class="small fw-bold">
                        ðŸ’¬ Comments ({{ item.comments|length if item.comments else 0 }})
                    </span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor"
                        class="bi bi-chevron-down" viewBox="0 0 16 16">
                        <path fill-rule="evenodd"
                            d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708" />
                    </svg>
                </button>
                <div class="collapse mt-2" id="comments-{{ item.id }}">
                    {% if item.comments %}
                    <div class="list-group list-group-flush mb-2 small">
                        {% for comment in item.comments %}
                        <div class="list-group-item bg-light px-2 py-1 border-0 rounded mb-1">
                            <strong>{{ comment.author.name }}:</strong> {{ comment.text }}
                            <div class="text-muted" style="font-size: 0.7em;">{{ comment.created_at.strftime('%b %d,
                                %H:%M') }}</div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted small mb-2 fst-italic">No comments yet. Start a secret thread!</p>
                    {% endif %}
                    <form action="{{ url_for('add_comment', item_id=item.id) }}" method="post">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                        <div class="input-group input-group-sm">
                            <input type="text" name="text" class="form-control" placeholder="Discuss this gift..."
                                required>
                            <button class="btn btn-outline-secondary" type="submit">Post</button>
                        </div>
                        <small class="text-muted" style="font-size: 0.65em;">Hidden from {{ item.user.name }}</small>
                    </form>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>