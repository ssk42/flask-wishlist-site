{% extends 'base.html' %}

{% block title %}My Claims Â· Wishlist App{% endblock %}

{% block content %}
<div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between mb-4">
    <div>
        <h1 class="h3 mb-1">My Claims</h1>
        <p class="text-muted mb-0">Items you've claimed or purchased for others.</p>
    </div>
    <div class="mt-3 mt-md-0">
        <a href="{{ url_for('items') }}" class="btn btn-outline-primary btn-sm">Back to All Items</a>
    </div>
</div>

{% if claimed_count > 0 or purchased_count > 0 %}
<div class="card shadow-sm mb-4">
    <div class="card-header bg-white">
        <h2 class="h6 mb-0">Summary</h2>
    </div>
    <div class="card-body">
        <div class="row text-center">
            <div class="col-6">
                <div class="h3 mb-0 text-warning">{{ claimed_count }}</div>
                <small class="text-muted">Claimed (awaiting purchase)</small>
            </div>
            <div class="col-6">
                <div class="h3 mb-0 text-success">{{ purchased_count }}</div>
                <small class="text-muted">Purchased (awaiting receipt)</small>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if grouped_items %}
    {% for group in grouped_items %}
        <section class="mb-5">
            <div class="d-flex align-items-center mb-3">
                <h2 class="h4 mb-0">For {{ group.user.name }}</h2>
                <span class="badge bg-light text-dark ms-3">{{ group.items|length }} item{{ 's' if group.items|length != 1 else '' }}</span>
            </div>
            <div class="row">
                {% for item in group.items %}
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card h-100 shadow-sm">
                            <img src="{{ item.image_url or default_image_url }}" class="card-img-top" alt="Image for {{ item.description }}" loading="lazy">
                            <div class="card-body d-flex flex-column">
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <span class="badge rounded-pill {{ 'bg-warning text-dark' if item.status == 'Claimed' else 'bg-success' }} status-pill">{{ item.status }}</span>
                                    {% if item.priority %}
                                        <span class="badge rounded-pill {{ 'badge-priority-' ~ item.priority|lower }}">{{ item.priority }}</span>
                                    {% endif %}
                                </div>
                                <h3 class="h5">{{ item.description }}</h3>
                                {% if item.category %}
                                    <p class="text-muted mb-1"><strong>Category:</strong> {{ item.category }}</p>
                                {% endif %}
                                {% if item.price %}
                                    <p class="mb-1">
                                        <strong>Price:</strong> ${{ '%.2f'|format(item.price) }}
                                        {% if item.price_updated_at %}
                                            <small class="text-muted">(as of {{ item.price_updated_at.strftime('%b %d') }})</small>
                                        {% endif %}
                                    </p>
                                {% endif %}
                                <p class="text-muted mb-2"><strong>For:</strong> {{ item.user.name }}</p>
                                {% if item.link %}
                                    <div class="d-flex gap-2 mb-2 flex-wrap">
                                        <a href="{{ item.link }}" target="_blank" rel="noopener" class="btn btn-sm btn-outline-primary">View item</a>
                                        <form action="{{ url_for('refresh_price', item_id=item.id) }}" method="post" class="d-inline">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                            <button type="submit" class="btn btn-sm btn-outline-secondary" title="Fetch current price from URL">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                                                    <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                                                    <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                                                </svg>
                                                Refresh Price
                                            </button>
                                        </form>
                                    </div>
                                {% endif %}
                                <div class="mt-auto pt-3">
                                    <a href="{{ url_for('edit_item', item_id=item.id) }}" class="btn btn-primary btn-sm w-100">Update Status</a>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </section>
    {% endfor %}
{% else %}
    <div class="empty-state">
        <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-gift" viewBox="0 0 16 16">
            <path d="M3 2.5a2.5 2.5 0 0 1 5 0 2.5 2.5 0 0 1 5 0v.006c0 .07 0 .27-.038.494H15a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1v7.5a1.5 1.5 0 0 1-1.5 1.5h-11A1.5 1.5 0 0 1 1 14.5V7a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h2.038A2.968 2.968 0 0 1 3 2.506V2.5zm1.068.5H7v-.5a1.5 1.5 0 1 0-3 0c0 .085.002.274.045.43a.522.522 0 0 0 .023.07zM9 3h2.932a.56.56 0 0 0 .023-.07c.043-.156.045-.345.045-.43a1.5 1.5 0 0 0-3 0V3zM1 4v2h6V4H1zm8 0v2h6V4H9zm5 3H9v8h4.5a.5.5 0 0 0 .5-.5V7zm-7 8V7H2v7.5a.5.5 0 0 0 .5.5H7z"/>
        </svg>
        <h2 class="h4 mb-2">No claimed items yet</h2>
        <p class="text-muted mb-4">When you claim items for others, they'll appear here so you can track them.</p>
        <a class="btn btn-primary" href="{{ url_for('items') }}">
            Browse Wishlists
        </a>
    </div>
{% endif %}
{% endblock %}
