{% extends 'base.html' %}

{% block title %}Edit Item Â· Wishlist App{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <h1 class="h3 mb-3">Edit item</h1>
        <p class="text-muted mb-4">Make updates and keep everyone in the loop.</p>
        <form action="{{ url_for('items.edit_item', item_id=item.id) }}" method="post" class="glass-card p-4">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            {% if item.user_id == current_user.id %}
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="description" class="form-label">Description</label>
                    <input type="text" class="form-control" id="description" name="description" maxlength="750" required
                        value="{{ item.description }}">
                </div>
                <div class="col-md-6">
                    <label for="link" class="form-label">Link</label>
                    <div class="input-group">
                        <input type="url" class="form-control" id="link" name="link" value="{{ item.link or '' }}">
                        <button class="btn btn-outline-secondary" type="button" id="autofill-btn"
                            title="Autofill details from URL">
                            ðŸª„ Autofill
                        </button>
                    </div>
                </div>
            </div>

            <div class="row g-3 mt-2">
                <div class="col-md-3">
                    <label for="price" class="form-label">Price</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" class="form-control" id="price" name="price" step="0.01" min="0"
                            value="{{ item.price or '' }}">
                    </div>
                </div>
                <div class="col-md-3">
                    <label for="priority" class="form-label">Priority</label>
                    <select class="form-select" id="priority" name="priority">
                        {% for priority in priority_choices %}
                        <option value="{{ priority }}" {% if item.priority==priority %}selected{% endif %}>{{ priority
                            }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="category" class="form-label">Category</label>
                    <input type="text" class="form-control" id="category" name="category"
                        value="{{ item.category or '' }}">
                </div>
                <div class="col-md-3">
                    <label for="image_url" class="form-label">Image URL</label>
                    <input type="url" class="form-control" id="image_url" name="image_url"
                        value="{{ item.image_url or '' }}">
                </div>
            </div>

            {% if events %}
            <div class="row g-3 mt-2">
                <div class="col-md-6">
                    <label for="event_id" class="form-label">Event (optional)</label>
                    <select id="event_id" name="event_id" class="form-select">
                        <option value="">No event</option>
                        {% for event in events %}
                        <option value="{{ event.id }}" {% if item.event_id==event.id %}selected{% endif %}>
                            {{ event.name }} ({{ event.date.strftime('%b %d, %Y') }})
                        </option>
                        {% endfor %}
                    </select>
                    <small class="form-text text-muted">Associate this item with an upcoming event.</small>
                </div>
            </div>
            {% endif %}

            <div class="row g-3 mt-2">
                <div class="col-12">
                    <label class="form-label text-muted">Variants (optional)</label>
                </div>
                <div class="col-md-4">
                    <label for="size" class="form-label">Size</label>
                    <input type="text" class="form-control" id="size" name="size" maxlength="50" placeholder="M, L, XL..." value="{{ item.size or '' }}">
                </div>
                <div class="col-md-4">
                    <label for="color" class="form-label">Color</label>
                    <input type="text" class="form-control" id="color" name="color" maxlength="50" placeholder="Blue, Red..." value="{{ item.color or '' }}">
                </div>
                <div class="col-md-4">
                    <label for="quantity" class="form-label">Quantity</label>
                    <input type="number" class="form-control" id="quantity" name="quantity" min="1" max="99" placeholder="1" value="{{ item.quantity or '' }}">
                </div>
                <div class="col-12">
                    <small class="form-text text-muted">Specify size, color, or quantity if it matters for this item.</small>
                </div>
            </div>
            {% else %}
            <div class="alert alert-info">
                You're updating <strong>{{ item.user.name }}'s</strong> item. Feel free to change the status once you've
                purchased or delivered it.
            </div>
            {% endif %}

            {% if item.user_id != current_user.id %}
            <div class="mt-3">
                <label for="status" class="form-label">Status</label>
                <select class="form-select" id="status" name="status">
                    {% for status in status_choices %}
                    <option value="{{ status }}" {% if item.status==status %}selected{% endif %}>{{ status }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}

            <div class="d-flex justify-content-end mt-4 gap-2">
                <a href="{{ url_for('items.items_list') }}" class="btn btn-outline-secondary">Cancel</a>
                <button type="submit" class="btn btn-primary">Save changes</button>
            </div>
        </form>
    </div>
</div>

<script>
    document.getElementById('autofill-btn')?.addEventListener('click', async function () {
        const linkInput = document.getElementById('link');
        const url = linkInput.value;
        if (!url) {
            alert('Please enter a URL first');
            return;
        }

        const btn = this;
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Fetching...';

        try {
            const response = await fetch('/api/fetch-metadata', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
                },
                body: JSON.stringify({ url: url })
            });

            const data = await response.json();
            if (data.error) {
                console.error(data.error);
                alert('Could not fetch details. Please fill manually.');
            } else {
                if (data.title) {
                    document.getElementById('description').value = data.title.substring(0, 749);
                }
                if (data.price) document.getElementById('price').value = data.price;
                if (data.image_url) document.getElementById('image_url').value = data.image_url;
                if (data.category && document.getElementById('category')) {
                    if (!document.getElementById('category').value) {
                        document.getElementById('category').value = data.category;
                    }
                }

                linkInput.classList.add('is-valid');
                setTimeout(() => linkInput.classList.remove('is-valid'), 2000);
            }
        } catch (e) {
            console.error(e);
            alert('Failed to connect to server.');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    });
</script>
{% endblock %}